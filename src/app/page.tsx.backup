'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { useToast } from '@/hooks/use-toast'
import { Truck, Shield, CreditCard, CheckCircle, Loader2 } from 'lucide-react'
import Script from 'next/script'
import {
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselNext,
  CarouselPrevious,
} from "@/components/ui/carousel"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
import { Header } from '@/components/Header'
import { Footer } from '@/components/Footer'

export default function ProductPage() {
  const [quantity, setQuantity] = useState(4)
  const [isProcessing, setIsProcessing] = useState(false)
  const [showPaymentConfirmation, setShowPaymentConfirmation] = useState(false)
  const [showDeliveryDialog, setShowDeliveryDialog] = useState(false)
  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    email: '',
    cep: '',
    address: '',
    number: '',
    complement: '',
    neighborhood: '',
    city: '',
    state: ''
  })
  const { toast } = useToast()

  // Product images
  const productImages = [
    "https://z-cdn-media.chatglm.cn/files/88227448-75f5-45c9-8721-596d77fe2d21_Pneu%20XBRI%20BRUTUS%20TA%20%281%29.png?auth_key=1793210075-10a7e776430a4995944daa272ea59a8e-0-f629304e54172b6194951ce4113e7d94",
    "https://z-cdn-media.chatglm.cn/files/2523d3a8-e526-4772-af5d-809f3a6c88ec_Pneu%20XBRI%20BRUTUS%20TA%20%284%29.png?auth_key=1793210075-f3a5260704c94b6d9c0d1a2363a2550f-0-dfcdec6e39b908166559172f5072287c",
    "https://z-cdn-media.chatglm.cn/files/94c3618b-94cc-4f53-bf76-a82846882ce5_Pneu%20XBRI%20BRUTUS%20TA%20%283%29.png?auth_key=1793210075-f4213f12d3b142d49c7cbbf0f2819950-0-d516f891833e948a6dffadd6b1d41122",
    "https://z-cdn-media.chatglm.cn/files/3ee371a6-50ce-475f-bcc7-923c3d73fa90_Pneu%20XBRI%20BRUTUS%20TA%20%282%29.png?auth_key=1793210075-4e85172bbc69458fb0c2b75ad768f6e1-0-092bb5db24bb8f79e6b1cd2760b9737f",
    "https://z-cdn-media.chatglm.cn/files/52815214-59ad-4d4a-b93b-de3c35d98458_Pneu%20XBRI%20BRUTUS%20TA%20%281%29.png?auth_key=1793210075-0c67e3ba98aa44e9a56b134e551a202a-0-d99defdd520759bc0eece7a3124f694b",
    "https://z-cdn-media.chatglm.cn/files/03c4727d-f7cf-4d75-a6e9-952e490222c8_Pneu%20XBRI%20BRUTUS%20TA%20%284%29.png?auth_key=1793210075-367a851b49444917bbbc13fde2c775c5-0-e82ae880ae4e94e7f769e9df0a878a8c",
    "https://z-cdn-media.chatglm.cn/files/ece20aa8-94c7-4802-b4e0-3f03759b3853_Pneu%20XBRI%20BRUTUS%20TA%20%283%29.png?auth_key=1793210075-a37a4601419f47309b9d53e963102b11-0-b6e9c5f3c7ea2da3b870f01fffda0dc8"
  ]

  const originalPrice = 3200
  const currentPrice = 2600
  const discount = ((originalPrice - currentPrice) / originalPrice) * 100

  const handleQuantityChange = (newQuantity: number) => {
    setQuantity(newQuantity)
  }

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target
    setFormData(prev => ({ ...prev, [name]: value }))
  }

  const buscarEndereco = async (cep: string) => {
    if (cep.length !== 8) return
    
    try {
      const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`)
      const data = await response.json()
      
      if (!data.erro) {
        setFormData(prev => ({
          ...prev,
          address: data.logradouro || '',
          neighborhood: data.bairro || '',
          city: data.localidade || '',
          state: data.uf || ''
        }))
        toast.success('Endere√ßo encontrado!')
      }
    } catch (error) {
      toast.error('CEP n√£o encontrado')
    }
  }

  const handleBuyNow = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsProcessing(true)

    try {
      // Mostrar confirma√ß√£o de pagamento diretamente, sem valida√ß√£o obrigat√≥ria
      setShowPaymentConfirmation(true)
      toast({
        title: "Pedido iniciado!",
        description: `Voc√™ est√° comprando ${quantity} pneu(s) por R$${(currentPrice * quantity / 4).toFixed(2)}`,
      })

    } catch (error: any) {
      toast({
        title: "Erro",
        description: error.message || "Ocorreu um erro ao processar seu pedido",
        variant: "destructive"
      })
    } finally {
      setIsProcessing(false)
    }
  }

  const handlePaymentConfirmation = () => {
    // Redirecionar para o site principal
    window.location.href = 'https://mercadolivre.scpneus.shop/'
  }

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL',
      minimumFractionDigits: 2
    }).format(price)
  }

  // Delivery Form Component
  const DeliveryForm = () => (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-2">Dados Pessoais</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <Label htmlFor="name">Nome Completo</Label>
            <Input
              id="name"
              name="name"
              value={formData.name}
              onChange={handleInputChange}
              placeholder="Jo√£o Silva"
            />
          </div>
          <div>
            <Label htmlFor="phone">Telefone</Label>
            <Input
              id="phone"
              name="phone"
              value={formData.phone}
              onChange={handleInputChange}
              placeholder="(11) 98765-4321"
            />
          </div>
        </div>
        <div className="mt-4">
          <Label htmlFor="email">E-mail</Label>
          <Input
            id="email"
            name="email"
            type="email"
            value={formData.email}
            onChange={handleInputChange}
            placeholder="joao@email.com"
          />
        </div>
      </div>

      <Separator />

      <div>
        <h3 className="text-lg font-semibold mb-2">Endere√ßo de Entrega</h3>
        <div>
          <Label htmlFor="cep">CEP</Label>
          <Input
            id="cep"
            name="cep"
            value={formData.cep}
            onChange={(e) => {
              const value = e.target.value.replace(/\D/g, '');
              setFormData(prev => ({ ...prev, cep: value }));
              if (value.length === 8) {
                buscarEndereco(value);
              }
            }}
            placeholder="01234567"
            maxLength={8}
          />
        </div>

        <div className="grid md:grid-cols-2 gap-4 mt-4">
          <div className="md:col-span-2">
            <Label htmlFor="address">Endere√ßo</Label>
            <Input
              id="address"
              name="address"
              value={formData.address}
              onChange={handleInputChange}
              placeholder="Rua das Flores"
            />
          </div>
          <div>
            <Label htmlFor="number">N√∫mero</Label>
            <Input
              id="number"
              name="number"
              value={formData.number}
              onChange={handleInputChange}
              placeholder="123"
            />
          </div>
          <div>
            <Label htmlFor="complement">Complemento</Label>
            <Input
              id="complement"
              name="complement"
              value={formData.complement}
              onChange={handleInputChange}
              placeholder="Apto 101"
            />
          </div>
        </div>

        <div className="grid md:grid-cols-3 gap-4 mt-4">
          <div>
            <Label htmlFor="neighborhood">Bairro</Label>
            <Input
              id="neighborhood"
              name="neighborhood"
              value={formData.neighborhood}
              onChange={handleInputChange}
              placeholder="Centro"
            />
          </div>
          <div>
            <Label htmlFor="city">Cidade</Label>
            <Input
              id="city"
              name="city"
              value={formData.city}
              onChange={handleInputChange}
              placeholder="S√£o Paulo"
            />
          </div>
          <div>
            <Label htmlFor="state">Estado</Label>
            <Input
              id="state"
              name="state"
              value={formData.state}
              onChange={handleInputChange}
              placeholder="SP"
              maxLength={2}
            />
          </div>
        </div>
      </div>

      <div className="flex gap-3 pt-4">
        <Button 
          variant="outline" 
          className="flex-1"
          onClick={() => setShowDeliveryDialog(false)}
        >
          Cancelar
        </Button>
        <Button 
          className="ml-button-primary flex-1 bg-blue-600 hover:bg-blue-700"
          onClick={() => {
            setShowDeliveryDialog(false)
            toast({
              title: "Dados de entrega salvos!",
              description: "Suas informa√ß√µes foram armazenadas com sucesso.",
            })
          }}
        >
          Confirmar Dados
        </Button>
      </div>
    </div>
  )

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <div className="ml-container py-8">
        <div className="grid lg:grid-cols-2 gap-8">
          {/* Product Image Section */}
          <div className="space-y-4">
            <Card className="ml-product-card overflow-hidden">
              <div className="relative">
                <Carousel
                  opts={{
                    align: "start",
                  }}
                  className="w-full"
                >
                  <CarouselContent>
                    {productImages.map((image, index) => (
                      <CarouselItem key={index}>
                        <div className="aspect-square bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center overflow-hidden">
                          <img
                            src={image}
                            alt={`Pneu XBRI BRUTUS T/A - Vista ${index + 1}`}
                            className="w-full h-full object-contain"
                            onError={(e) => {
                              // Fallback to placeholder if image fails to load
                              e.currentTarget.style.display = 'none';
                              e.currentTarget.parentElement!.innerHTML = `
                                <div class="text-center">
                                  <div class="w-32 h-32 mx-auto mb-4 bg-gray-400 rounded-full flex items-center justify-center">
                                    <span class="text-4xl">üõû</span>
                                  </div>
                                  <p class="text-gray-600">4 Pneus XBRI BRUTUS 265 75 R16</p>
                                </div>
                              `;
                            }}
                          />
                        </div>
                      </CarouselItem>
                    ))}
                  </CarouselContent>
                  <CarouselPrevious className="ml-4" />
                  <CarouselNext className="mr-4" />
                </Carousel>
              </div>
            </Card>

            {/* Product Highlights */}
            <Card className="ml-product-card">
              <CardHeader>
                <CardTitle className="text-lg">Destaques do Produto</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                  <span className="text-sm">Alta durabilidade</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                  <span className="text-sm">√ìtima ader√™ncia</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                  <span className="text-sm">Efici√™ncia de combust√≠vel</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                  <span className="text-sm">Seguran√ßa em diversos terrenos</span>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Product Details and Form Section */}
          <div className="space-y-6">
            {/* Product Info */}
            <Card className="ml-product-card">
              <CardHeader>
                <div className="flex items-start justify-between">
                  <div>
                    <CardTitle className="text-2xl font-bold text-gray-900 mb-2">
                      4 Pneus XBRI BRUTUS 265 75 R16
                    </CardTitle>
                    <Badge variant="outline" className="mb-4">
                      Pneus para Todos os Terrenos
                    </Badge>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Pricing Section */}
                <div className="space-y-3">
                  <div className="flex items-baseline gap-3">
                    <span className="ml-price text-3xl font-bold text-green-600">
                      <span className="ml-price-symbol">R$</span>
                      {formatPrice(currentPrice * quantity / 4).replace('R$', '').trim()}
                    </span>
                    {quantity === 4 && (
                      <span className="text-lg text-gray-500 line-through">
                        R$ {formatPrice(originalPrice).replace('R$', '').trim()}
                      </span>
                    )}
                  </div>
                  {quantity === 4 && (
                    <Badge className="bg-red-100 text-red-800 animate-pulse">
                      {discount.toFixed(0)}% OFF
                    </Badge>
                  )}
                  <div className="space-y-1">
                    <p className="text-sm text-gray-600">
                      Pre√ßo por {quantity} pneu(s)
                    </p>
                    <p className="text-sm text-gray-600">
                      Pre√ßo unit√°rio: {formatPrice(currentPrice / 4)}
                    </p>
                    <p className="text-sm font-semibold text-green-600">
                      ‚úÖ Frete Gr√°tis
                    </p>
                  </div>
                </div>

                <Separator />

                {/* Quantity Selector */}
                <div className="space-y-3">
                  <h3 className="font-semibold">Selecione a quantidade:</h3>
                  <div className="grid grid-cols-4 gap-2">
                    {[1, 2, 3, 4].map((qty) => (
                      <Button
                        key={qty}
                        variant={quantity === qty ? "default" : "outline"}
                        className="h-12"
                        onClick={() => handleQuantityChange(qty)}
                      >
                        {qty} {qty === 1 ? 'pneu' : 'pneus'}
                      </Button>
                    ))}
                  </div>
                </div>

                <Separator />

                {/* Action Buttons */}
                <div className="space-y-3">
                  <Dialog open={showDeliveryDialog} onOpenChange={setShowDeliveryDialog}>
                    <DialogTrigger asChild>
                      <Button 
                        variant="outline" 
                        className="w-full h-12 text-base"
                      >
                        üì¶ Inserir dados da entrega
                      </Button>
                    </DialogTrigger>
                    <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
                      <DialogHeader>
                        <DialogTitle className="flex items-center gap-2">
                          <Truck className="h-5 w-5" />
                          Dados de Entrega
                        </DialogTitle>
                        <DialogDescription>
                          Preencha suas informa√ß√µes de entrega para finalizar o pedido.
                        </DialogDescription>
                      </DialogHeader>
                      <DeliveryForm />
                    </DialogContent>
                  </Dialog>
                  
                  <Button 
                    className="ml-button-primary w-full h-12 text-base bg-blue-600 hover:bg-blue-700"
                    onClick={() => {
                      // Redirect to MercadoPago payment
                      window.open('https://mpago.la/1nRPFmJ', '_blank');
                      // Show confirmation toast
                      toast({
                        title: "Redirecionando para pagamento",
                        description: "Voc√™ ser√° redirecionado para o Mercado Pago para finalizar sua compra.",
                      });
                    }}
                  >
                    üí≥ Pagar com Mercado Pago
                  </Button>
                </div>

                <Separator />

                {/* Product Description with Technical Info */}
                <div className="space-y-4">
                  <h3 className="font-semibold text-lg">Descri√ß√£o do Produto</h3>
                  <div className="text-gray-700 space-y-3 text-sm">
                    <p><strong>Xbri Brutus T/A.</strong></p>
                    <p><strong>Estabilidade e controle</strong><br />
                    Gra√ßas √† sua boa ader√™ncia, este pneu garante um √≥ptimo rendimento, pois se adapta √† usabilidade do seu carro.</p>
                    
                    <p><strong>Alta efici√™ncia</strong><br />
                    Este pneu est√° preparado para maximizar a efici√™ncia do combust√≠vel, a sua leveza e combina√ß√£o dos seus materiais garantir√£o um √≥timo rendimento nas suas viagens.</p>
                    
                    <p><strong>A seguran√ßa que voc√™ estava procurando</strong><br />
                    Adequado para todo tipo de superf√≠cie, se adere com muita for√ßa. √â ideal para o asfalto, a terra, a areia ou as pedras, usa uma maior tra√ß√£o e evita que o nosso veh√≠culo derrape.</p>
                    
                    <div className="bg-yellow-50 p-3 rounded-lg mt-4">
                      <p className="text-xs text-yellow-800">
                        <strong>Aviso legal:</strong> N√£o inclui roda.
                      </p>
                    </div>

                    <Separator className="my-4" />

                    <h4 className="font-semibold text-base">Informa√ß√µes T√©cnicas</h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Modelo:</span>
                        <span className="font-medium">XBRI BRUTUS</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Medida:</span>
                        <span className="font-medium">265 75 R16</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Tipo:</span>
                        <span className="font-medium">T/A (Todos os Terrenos)</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Garantia:</span>
                        <span className="font-medium">6 meses</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">√çndice de Carga:</span>
                        <span className="font-medium">112/109R</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Largura:</span>
                        <span className="font-medium">265 mm</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Perfil:</span>
                        <span className="font-medium">75</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Aro:</span>
                        <span className="font-medium">16"</span>
                      </div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>

      {/* Payment Confirmation Modal */}
      {showPaymentConfirmation && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <Card className="w-full max-w-md">
            <CardHeader>
              <CardTitle className="text-center text-lg">Confirmar Pagamento</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <Alert className="bg-green-50 border-green-200">
                <CheckCircle className="h-4 w-4 text-green-600" />
                <AlertDescription className="text-green-700">
                  Seus dados foram confirmados! Clique abaixo para acessar o Mercado Pago e finalizar o pagamento.
                </AlertDescription>
              </Alert>
              
              <div className="text-center space-y-2">
                <p className="text-sm text-gray-600">
                  Voc√™ ser√° redirecionado para o ambiente seguro do Mercado Pago
                </p>
                <p className="font-medium">
                  {quantity} pneu(s) XBRI BRUTUS - R${formatPrice(currentPrice * quantity / 4).replace('R$', '').trim()}
                </p>
              </div>

              <div className="space-y-2">
                <Button 
                  onClick={handlePaymentConfirmation}
                  className="w-full"
                >
                  Sim, eu completei o pagamento
                </Button>
                <Button 
                  variant="outline" 
                  onClick={() => setShowPaymentConfirmation(false)}
                  className="w-full"
                >
                  Voltar
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Footer */}
      <footer className="bg-gray-900 text-white py-12 mt-16">
        <div className="ml-container">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
            {/* Company Info */}
            <div className="space-y-4">
              <div className="flex items-center space-x-2">
                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                  <span className="text-white font-bold text-sm">SC</span>
                </div>
                <span className="text-xl font-bold">SCPNEUS</span>
              </div>
              <p className="text-gray-300 text-sm">
                Distribuidora de pneus premium com mais de 15 anos de experi√™ncia no mercado. 
                Qualidade e confian√ßa em cada produto.
              </p>
            </div>

            {/* Quick Links */}
            <div className="space-y-4">
              <h3 className="font-semibold">Links R√°pidos</h3>
              <ul className="space-y-2 text-sm">
                <li><a href="#" className="text-gray-300 hover:text-blue-400">Produtos</a></li>
                <li><a href="#" className="text-gray-300 hover:text-blue-400">Promo√ß√µes</a></li>
                <li><a href="#" className="text-gray-300 hover:text-blue-400">Servi√ßos</a></li>
                <li><a href="#" className="text-gray-300 hover:text-blue-400">Garantia</a></li>
              </ul>
            </div>

            {/* Customer Service */}
            <div className="space-y-4">
              <h3 className="font-semibold">Atendimento</h3>
              <ul className="space-y-2 text-sm">
                <li className="flex items-center space-x-2">
                  <svg className="h-4 w-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  <span className="text-gray-300">(11) 98765-4321</span>
                </li>
                <li className="flex items-center space-x-2">
                  <svg className="h-4 w-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  <span className="text-gray-300">contato@scpneus.com.br</span>
                </li>
              </ul>
            </div>

            {/* Newsletter */}
            <div className="space-y-4">
              <h3 className="font-semibold">Newsletter</h3>
              <p className="text-gray-300 text-sm">
                Receba nossas ofertas e novidades exclusivas
              </p>
              <div className="space-y-2">
                <input
                  type="email"
                  placeholder="Seu e-mail"
                  className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white placeholder-gray-400 text-sm"
                />
                <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md text-sm">
                  Assinar
                </button>
              </div>
            </div>
          </div>

          <div className="border-t border-gray-800 mt-8 pt-8">
            <div className="flex flex-col md:flex-row justify-between items-center">
              <p className="text-gray-400 text-sm">
                ¬© 2024 SCPNEUS. Todos os direitos reservados.
              </p>
              <div className="flex space-x-6 mt-4 md:mt-0">
                <a href="#" className="text-gray-400 hover:text-blue-400 text-sm">Pol√≠tica de Privacidade</a>
                <a href="#" className="text-gray-400 hover:text-blue-400 text-sm">Termos de Uso</a>
              </div>
            </div>
          </div>
        </div>
      <Footer />
    </div>
  )
}